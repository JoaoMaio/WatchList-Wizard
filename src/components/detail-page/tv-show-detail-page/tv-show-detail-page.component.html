<div *ngIf="!isLoading" class="page">
  <div class="card">
    <div class="backdrop">
      <img *ngIf="api.doesBackDropExist(tvshow?.backdrop_path)" src="{{tvshow?.backdrop_path}}" alt="backdrop" />
      <img *ngIf="!api.doesBackDropExist(tvshow?.backdrop_path)" src="404.png" alt="backdrop" class="error_image" />
      <div class="title_checkmark">
        <div class="info">
          <h1 class="title">{{ tvshow?.name }}</h1>
          <div class="countSeasons_RunTime">
            <span *ngIf="tvshow?.number_of_seasons === 1">{{ tvshow?.number_of_seasons }} Season</span>
            <span *ngIf="tvshow?.number_of_seasons! > 1">{{ tvshow?.number_of_seasons }} Seasons</span>
          </div>
        </div>
          <div class="markAsWatchedTitle">
            <button *ngIf="!isOnWatchList" (click)="addShowToWatchList()" class="markAsWatchedbutton">
              +
            </button>
            <button *ngIf="isOnWatchList" (click)="removeShowsFromWatchList()" class="markAsWatchedbutton watched">
              ✓
            </button>
          </div>
      </div>

    </div>
  </div>

  <div class="content">
    <div class="tvshow_info">
      <div class="overview-container">
        <p class="overview" [ngClass]="{ 'expanded': isOverviewExpanded }">{{ tvshow?.overview }}</p>
        <button class="toggle-button" (click)="isOverviewExpanded = !isOverviewExpanded">
          {{ isOverviewExpanded ? 'Show Less' : 'Show More' }}
        </button>
      </div>
      
      <div class="divider"></div>

      <div class="providers_section">
        <p>Watch on:</p>
        <div class="providers">
          <span *ngFor="let provider of tvshow?.watch_providers">
            <img src="https://image.tmdb.org/t/p/w500/{{ provider.logo_path }}" alt="{{ provider.provider_name }}" />
            <p>{{ provider.provider_name }}</p>
          </span>
        </div>
      </div>

      <div class="divider"></div>

      <div class="rating">
        <span>{{ tvshow?.vote_average?.toPrecision(3) }} / 10</span>
      </div>

      <div class="divider"></div>

      <div class="seasons">
        <mat-accordion *ngFor="let season of seasons">
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <div class="m_desc">
                  <mat-panel-title>
                    Season {{ season.season_number }}
                  </mat-panel-title>
                  <mat-panel-description>
                    {{ getCountWatchedEpisodes(season) }} / {{ season.episode_count }}
                  </mat-panel-description>
                </div>
                <mat-progress-bar mode="determinate" [value]="getWatchedPercentage(season)"></mat-progress-bar>
              </mat-expansion-panel-header>
              
              <div *ngFor="let episode of season.episodes" class="episode-details">
                  <div class="image_container">
                    <img *ngIf="api.doesBackDropExist(episode.still_path)" src="https://image.tmdb.org/t/p/w500/{{ episode.still_path }}" alt="episode still" />
                    <img *ngIf="!api.doesBackDropExist(episode.still_path)" src="tba.png" alt="to be announced" />

                  </div>
                  <div class="text_container">
                    <p class="episode-title">Episode {{ episode.episode_number }} - {{ episode.name }}</p>
                  </div>
                  <div class="markAsWatched" *ngIf="api.doesBackDropExist(episode.still_path)">
                    <button *ngIf="!episode.watched" (click)="markEpisodeAsWatched(episode)" class="markAsWatchedbutton">
                      +
                    </button>
                    <button *ngIf="episode.watched" (click)="markEpisodeAsUnWatched(episode)" class="markAsWatchedbutton watched">
                      ✓
                    </button>
                  </div>
                  <div class="tba_days" *ngIf="!api.doesBackDropExist(episode.still_path)">
                      <p>{{getDaysUntiItsOut(episode)}} days </p>
                  </div>
              </div>
            </mat-expansion-panel>
        </mat-accordion>
      </div>
    </div>

  </div>
</div>


<!-- Optionally handle loading state -->
<div *ngIf="isLoading" class="loading">
  <p>Loading...</p>
</div>

<app-confirm-modal
    *ngIf="showConfirmModal"
    [title]="'You have missing episodes'" 
    [message]="'Do you want to mark all episodes before this one?'"
    (confirm)="onConfirm()"
    (cancel)="onCancel()"
></app-confirm-modal>